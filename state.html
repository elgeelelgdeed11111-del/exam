<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø¬ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø§Ù„Ø®Ø§ØµØ© - Ù„ÙˆØ­Ø© Ø§Ù„Ø´Ø±Ù</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Cairo', 'Segoe UI', sans-serif;
        }
        
        body {
            background: linear-gradient(145deg, #f0f2f5, #e6e9f0);
            min-height: 100vh;
            padding: 16px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        /* Header */
        .hero-header {
            background: white;
            border-radius: 40px;
            padding: 30px;
            margin-bottom: 24px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 20px;
            border-bottom: 6px solid #ffd700;
        }
        
        .hero-title h1 {
            color: #1a2b4c;
            font-size: 2.2rem;
            font-weight: 800;
            margin-bottom: 8px;
            background: linear-gradient(145deg, #1a2b4c, #2d3f5e);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .hero-title p {
            color: #64748b;
            font-size: 1rem;
        }
        
        .stats-badge {
            background: linear-gradient(145deg, #1a2b4c, #2d3f5e);
            color: white;
            padding: 15px 30px;
            border-radius: 50px;
            font-weight: 700;
            box-shadow: 0 10px 20px rgba(26,43,76,0.2);
        }
        
        /* Login Section */
        .login-container {
            background: white;
            border-radius: 40px;
            padding: 40px;
            max-width: 400px;
            margin: 60px auto;
            box-shadow: 0 30px 60px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .login-icon {
            width: 100px;
            height: 100px;
            background: linear-gradient(145deg, #1a2b4c, #2d3f5e);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            margin: 0 auto 20px;
            border: 4px solid #ffd700;
        }
        
        .password-input {
            width: 100%;
            padding: 18px 24px;
            border: 2px solid #e2e8f0;
            border-radius: 30px;
            font-size: 1rem;
            margin-bottom: 16px;
            text-align: center;
            direction: ltr;
        }
        
        .login-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(145deg, #1a2b4c, #2d3f5e);
            color: white;
            border: none;
            border-radius: 30px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
        }
        
        /* Main Dashboard */
        .dashboard {
            display: none;
        }
        
        /* Quick Stats */
        .quick-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: 30px;
            padding: 25px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.03);
            border: 1px solid rgba(0,0,0,0.03);
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .stat-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(145deg, #1a2b4c10, #2d3f5e10);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
        }
        
        .stat-info h3 {
            color: #64748b;
            font-size: 0.9rem;
            font-weight: 400;
            margin-bottom: 5px;
        }
        
        .stat-info .value {
            color: #1a2b4c;
            font-size: 2rem;
            font-weight: 800;
        }
        
        .stat-info .unit {
            color: #94a3b8;
            font-size: 0.9rem;
        }
        
        /* Top 3 Podium */
        .podium-section {
            margin-bottom: 40px;
        }
        
        .section-title {
            color: #1a2b4c;
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .podium {
            display: flex;
            align-items: flex-end;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .podium-card {
            background: white;
            border-radius: 30px;
            padding: 25px;
            width: 220px;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0,0,0,0.08);
            transition: transform 0.3s;
        }
        
        .podium-card:hover {
            transform: translateY(-5px);
        }
        
        .podium-card.gold {
            background: linear-gradient(145deg, #fbbf24, #f59e0b);
            color: white;
        }
        
        .podium-card.silver {
            background: linear-gradient(145deg, #94a3b8, #64748b);
            color: white;
        }
        
        .podium-card.bronze {
            background: linear-gradient(145deg, #b45309, #92400e);
            color: white;
        }
        
        .rank-badge {
            width: 50px;
            height: 50px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: 800;
            margin: 0 auto 15px;
        }
        
        .student-name {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .student-grade {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 15px;
        }
        
        .student-score {
            font-size: 2.2rem;
            font-weight: 800;
            margin-bottom: 5px;
        }
        
        .student-code {
            font-size: 0.8rem;
            opacity: 0.8;
            font-family: monospace;
        }
        
        /* Top 20 Table */
        .leaderboard-section {
            background: white;
            border-radius: 30px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 15px 30px rgba(0,0,0,0.05);
        }
        
        .leaderboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .refresh-btn {
            background: #f1f5f9;
            border: none;
            padding: 12px 25px;
            border-radius: 40px;
            font-weight: 600;
            color: #1a2b4c;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }
        
        .refresh-btn:active {
            transform: scale(0.95);
            background: #e2e8f0;
        }
        
        .table-responsive {
            overflow-x: auto;
            border-radius: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            background: #f8fafc;
            color: #1a2b4c;
            padding: 16px 12px;
            font-weight: 600;
            text-align: center;
        }
        
        td {
            padding: 14px 12px;
            border-bottom: 1px solid #f1f5f9;
            text-align: center;
        }
        
        .rank-1 td { background: #fef9e7; }
        .rank-2 td { background: #f7fafc; }
        .rank-3 td { background: #f5f5f5; }
        
        /* Student Search */
        .search-section {
            background: white;
            border-radius: 30px;
            padding: 25px;
            margin-bottom: 30px;
        }
        
        .search-box {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 25px;
        }
        
        .search-input {
            flex: 1;
            padding: 18px 25px;
            border: 2px solid #e2e8f0;
            border-radius: 30px;
            font-size: 1rem;
            min-width: 250px;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #1a2b4c;
        }
        
        .search-btn {
            padding: 18px 35px;
            background: linear-gradient(145deg, #1a2b4c, #2d3f5e);
            color: white;
            border: none;
            border-radius: 30px;
            font-weight: 600;
            cursor: pointer;
        }
        
        /* Student Progress Card */
        .student-progress {
            display: none;
            background: #f8fafc;
            border-radius: 25px;
            padding: 25px;
            margin-top: 20px;
        }
        
        .student-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .student-badge {
            background: #1a2b4c;
            color: white;
            padding: 8px 20px;
            border-radius: 40px;
        }
        
        .stats-grid-small {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        
        /* Chart Container */
        .chart-container {
            background: white;
            border-radius: 20px;
            padding: 20px;
            margin: 20px 0;
            height: 350px;
            overflow-x: auto;
        }
        
        .chart-bars {
            display: flex;
            align-items: flex-end;
            gap: 15px;
            height: 250px;
            min-width: 500px;
            padding: 10px 0;
        }
        
        .chart-bar-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            min-width: 60px;
        }
        
        .chart-bar {
            width: 100%;
            background: linear-gradient(145deg, #1a2b4c, #2d3f5e);
            border-radius: 8px 8px 0 0;
            transition: height 0.3s;
            min-height: 4px;
        }
        
        .chart-label {
            font-size: 0.75rem;
            color: #64748b;
            text-align: center;
            max-width: 100px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .chart-value {
            font-weight: 700;
            color: #1a2b4c;
            font-size: 0.9rem;
        }
        
        /* Results Timeline */
        .results-timeline {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: 400px;
            overflow-y: auto;
            padding: 5px;
        }
        
        .result-item {
            background: white;
            border-radius: 16px;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-right: 6px solid;
            transition: transform 0.2s;
        }
        
        .result-item:hover {
            transform: translateX(-5px);
        }
        
        .result-item.high {
            border-right-color: #2ecc71;
        }
        
        .result-item.medium {
            border-right-color: #f39c12;
        }
        
        .result-item.low {
            border-right-color: #e74c3c;
        }
        
        .result-info h4 {
            color: #1a2b4c;
            margin-bottom: 6px;
            font-size: 1rem;
        }
        
        .result-info p {
            color: #64748b;
            font-size: 0.85rem;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .result-badge {
            background: #f1f5f9;
            padding: 2px 8px;
            border-radius: 20px;
            font-size: 0.75rem;
            color: #1a2b4c;
        }
        
        .result-score {
            font-size: 1.8rem;
            font-weight: 800;
            color: #1a2b4c;
            min-width: 70px;
            text-align: center;
        }
        
        /* Week Badge */
        .week-badge {
            background: #1a2b4c;
            color: white;
            padding: 2px 10px;
            border-radius: 20px;
            font-size: 0.7rem;
            display: inline-block;
        }
        
        /* Loading */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(3px);
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f1f5f9;
            border-top-color: #1a2b4c;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Alert */
        .alert {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 16px 24px;
            border-radius: 60px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            display: none;
            align-items: center;
            gap: 12px;
            z-index: 1100;
            border-right: 6px solid;
        }
        
        .alert.success { border-right-color: #2ecc71; }
        .alert.error { border-right-color: #e74c3c; }
        
        /* Responsive */
        @media (max-width: 768px) {
            .podium-card {
                width: 100%;
            }
            
            .search-box {
                flex-direction: column;
            }
            
            .search-btn {
                width: 100%;
            }
            
            .result-item {
                flex-direction: column;
                text-align: center;
                gap: 10px;
            }
            
            .result-info p {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Hero Header -->
        <div class="hero-header">
            <div class="hero-title">
                <h1>ğŸ† Ù„ÙˆØ­Ø© Ø§Ù„Ø´Ø±Ù</h1>
                <p>Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø¬ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø§Ù„Ø®Ø§ØµØ© - Ù†Ø¸Ø§Ù… Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„ØªØ±Ø§ÙƒÙ…ÙŠØ©</p>
            </div>
            <div class="stats-badge" id="liveDate"></div>
        </div>

        <!-- Loading -->
        <div class="loading-overlay" id="loadingOverlay">
            <div class="spinner"></div>
        </div>

        <!-- Alert -->
        <div class="alert" id="alertMessage">
            <span id="alertText"></span>
        </div>

        <!-- Login Section -->
        <div class="login-container" id="loginSection">
            <div class="login-icon">ğŸ‘‘</div>
            <h2 style="margin-bottom: 20px;">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø´Ø±Ù</h2>
            <input type="password" class="password-input" id="adminPassword" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
            <button class="login-btn" onclick="login()">Ø¯Ø®ÙˆÙ„</button>
        </div>

        <!-- Main Dashboard -->
        <div class="dashboard" id="dashboard">
            <!-- Quick Stats -->
            <div class="quick-stats" id="quickStats">
                <div class="stat-card">
                    <div class="stat-icon">ğŸ“Š</div>
                    <div class="stat-info">
                        <h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø§Ø¨</h3>
                        <div class="value" id="totalStudents">0</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">ğŸ“</div>
                    <div class="stat-info">
                        <h3>Ø§Ù…ØªØ­Ù†ÙˆØ§ Ø§Ù„ÙŠÙˆÙ…</h3>
                        <div class="value" id="todayCount">0</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">â­</div>
                    <div class="stat-info">
                        <h3>Ø£Ø¹Ù„Ù‰ Ø¯Ø±Ø¬Ø© Ø§Ù„ÙŠÙˆÙ…</h3>
                        <div class="value" id="topToday">0</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">ğŸ†</div>
                    <div class="stat-info">
                        <h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª</h3>
                        <div class="value" id="totalExams">0</div>
                    </div>
                </div>
            </div>

            <!-- Podium (Top 3) -->
            <div class="podium-section">
                <div class="section-title">
                    <span>ğŸ¥‡ Ø£ÙˆØ§Ø¦Ù„ Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</span>
                </div>
                <div class="podium" id="podiumContainer">
                    <!-- Dynamic podium content -->
                </div>
            </div>

            <!-- Top 20 Leaderboard -->
            <div class="leaderboard-section">
                <div class="leaderboard-header">
                    <h2 class="section-title">ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ø´Ø±ÙŠÙ† Ø§Ù„Ø£ÙˆØ§Ø¦Ù„</h2>
                    <button class="refresh-btn" onclick="refreshLeaderboard()">
                        <span>ğŸ”„</span> ØªØ­Ø¯ÙŠØ«
                    </button>
                </div>
                <div class="table-responsive">
                    <table id="leaderboardTable">
                        <thead>
                            <tr>
                                <th>Ø§Ù„ØªØ±ØªÙŠØ¨</th>
                                <th>Ø§Ù„Ø§Ø³Ù…</th>
                                <th>Ø§Ù„Ù…Ø±Ø­Ù„Ø©</th>
                                <th>Ø§Ù„Ù†Ù‚Ø§Ø·</th>
                                <th>Ø¢Ø®Ø± Ø§Ù…ØªØ­Ø§Ù†</th>
                            </tr>
                        </thead>
                        <tbody id="leaderboardBody">
                            <!-- Dynamic content -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Student Search Section -->
            <div class="search-section">
                <h2 class="section-title">ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø·Ø§Ù„Ø¨</h2>
                <div class="search-box">
                    <input type="text" class="search-input" id="studentCode" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨ (Ù…Ø«Ø§Ù„: A247820)" maxlength="7">
                    <button class="search-btn" onclick="searchStudent()">Ø¨Ø­Ø«</button>
                </div>
                
                <!-- Student Progress -->
                <div class="student-progress" id="studentProgress">
                    <!-- Dynamic student data will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import { 
            getFirestore, 
            collection, 
            doc, 
            getDoc, 
            getDocs, 
            query, 
            where,
            orderBy,
            limit,
            onSnapshot,
            Timestamp 
        } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

        // ========== Firebase Config ==========
        const firebaseConfig = {
            apiKey: "AIzaSyB27lyphN9YxgB4eFwuKWi0ghjuAutpu8o",
            authDomain: "manssa-oloom1352007.firebaseapp.com",
            projectId: "manssa-oloom1352007",
            storageBucket: "manssa-oloom1352007.firebasestorage.app",
            messagingSenderId: "191595591961",
            appId: "1:191595591961:web:79ff9bbb52cc08cb862d88"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // ========== Constants ==========
        const ADMIN_PASSWORD = "admin123";
        
        const GRADE_NAMES = {
            'A': 'Ø§Ù„Ø±Ø§Ø¨Ø¹ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ',
            'B': 'Ø§Ù„Ø®Ø§Ù…Ø³ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ',
            'C': 'Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ',
            'D': 'Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ',
            'E': 'Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ'
        };

        const SUBJECT_NAMES = {
            'A': 'Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©',
            'E': 'Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©',
            'M': 'Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª',
            'S': 'Ø§Ù„Ø¹Ù„ÙˆÙ…',
            'D': 'Ø§Ù„Ø¯Ø±Ø§Ø³Ø§Øª Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ©'
        };

        // ========== State ==========
        let unsubscribeStats = null;

        // ========== UI Helpers ==========
        function showLoading() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        function showAlert(message, type = 'success') {
            const alert = document.getElementById('alertMessage');
            const text = document.getElementById('alertText');
            alert.className = `alert ${type}`;
            text.textContent = message;
            alert.style.display = 'flex';
            setTimeout(() => {
                alert.style.display = 'none';
            }, 3000);
        }

        function updateLiveDate() {
            const now = new Date();
            document.getElementById('liveDate').innerHTML = `
                ğŸ“… ${now.toLocaleDateString('ar-EG', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                })}
            `;
        }

        // ========== Login ==========
        window.login = function() {
            const password = document.getElementById('adminPassword').value;
            if (password === ADMIN_PASSWORD) {
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
                updateLiveDate();
                loadDashboard();
                showAlert('âœ… ØªÙ… Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­', 'success');
            } else {
                showAlert('âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©', 'error');
            }
        };

        // ========== Load Dashboard ==========
        async function loadDashboard() {
            showLoading();
            try {
                await Promise.all([
                    loadQuickStats(),
                    loadLeaderboard()
                ]);
            } catch (error) {
                console.error('Error loading dashboard:', error);
                showAlert('âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
            }
            hideLoading();
        }

        // ========== Quick Stats (Optimized with single document listener) ==========
        async function loadQuickStats() {
            try {
                // Get total students count
                const studentsSnap = await getDocs(collection(db, 'students'));
                document.getElementById('totalStudents').textContent = studentsSnap.size;

                // Get total exams count
                const examsSnap = await getDocs(collection(db, 'exams'));
                document.getElementById('totalExams').textContent = examsSnap.size;

                // Get today's results
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const todayStr = today.toISOString();

                const resultsRef = collection(db, 'results');
                const q = query(resultsRef, where('date', '>=', todayStr));
                const todaySnap = await getDocs(q);
                
                const todayResults = todaySnap.docs.map(doc => doc.data());
                document.getElementById('todayCount').textContent = todayResults.length;

                // Get top score today
                if (todayResults.length > 0) {
                    const topScore = Math.max(...todayResults.map(r => r.score || 0));
                    document.getElementById('topToday').textContent = topScore + '/10';
                } else {
                    document.getElementById('topToday').textContent = '0/10';
                }

            } catch (error) {
                console.error('Error loading quick stats:', error);
            }
        }

        // ========== Leaderboard (Ù…Ø¹ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†Ù‚Ø§Ø· Ù…Ù† Ø§Ù„Ù†ØªØ§Ø¦Ø¬) ==========
        async function loadLeaderboard() {
            try {
                // âœ… Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø£ÙˆÙ„Ø§Ù‹
                const resultsRef = collection(db, 'results');
                const resultsSnap = await getDocs(resultsRef);
                
                // Ø­Ø³Ø§Ø¨ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‚Ø§Ø· Ù„ÙƒÙ„ Ø·Ø§Ù„Ø¨ Ù…Ù† Ø§Ù„Ù†ØªØ§Ø¦Ø¬
                const studentScores = {};
                resultsSnap.forEach(doc => {
                    const result = doc.data();
                    const studentCode = result.studentCode;
                    const score = result.score || 0;
                    
                    if (!studentScores[studentCode]) {
                        studentScores[studentCode] = 0;
                    }
                    studentScores[studentCode] += score;
                });

                // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨
                const studentsRef = collection(db, 'students');
                const studentsSnap = await getDocs(studentsRef);
                
                const students = [];
                studentsSnap.forEach(doc => {
                    const student = doc.data();
                    const calculatedTotal = studentScores[student.code] || 0;
                    
                    students.push({
                        ...student,
                        calculatedTotalScore: calculatedTotal,
                        lastExamDate: student.lastExamDate || null
                    });
                });

                // ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø­Ø³ÙˆØ¨Ø©
                const sortedStudents = students.sort((a, b) => 
                    (b.calculatedTotalScore || 0) - (a.calculatedTotalScore || 0)
                ).slice(0, 20);

                renderPodium(sortedStudents.slice(0, 3));
                renderLeaderboardTable(sortedStudents);

            } catch (error) {
                console.error('Error loading leaderboard:', error);
                showAlert('âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ÙˆØ§Ø¦Ù„', 'error');
            }
        }

        // ========== Render Podium (Top 3) ==========
        function renderPodium(top3) {
            const podiumContainer = document.getElementById('podiumContainer');
            
            if (top3.length === 0) {
                podiumContainer.innerHTML = '<div style="text-align: center; padding: 40px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ§ÙÙŠØ©</div>';
                return;
            }

            const medals = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'];
            const colors = ['gold', 'silver', 'bronze'];

            let html = '';
            top3.forEach((student, index) => {
                html += `
                    <div class="podium-card ${colors[index]}">
                        <div class="rank-badge">${medals[index]}</div>
                        <div class="student-name">${student.name || 'Ø·Ø§Ù„Ø¨'}</div>
                        <div class="student-grade">${GRADE_NAMES[student.gradeLetter] || student.gradeLetter}</div>
                        <div class="student-score">${student.calculatedTotalScore || 0}</div>
                        <div class="student-code">${student.code || student.id}</div>
                    </div>
                `;
            });

            podiumContainer.innerHTML = html;
        }

        // ========== Render Leaderboard Table ==========
        function renderLeaderboardTable(students) {
            const tbody = document.getElementById('leaderboardBody');
            
            if (students.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨</td></tr>';
                return;
            }

            let html = '';
            students.forEach((student, index) => {
                const rankClass = index < 3 ? `rank-${index + 1}` : '';
                const lastExam = student.lastExamDate ? new Date(student.lastExamDate).toLocaleDateString('ar-EG') : 'Ù„Ù… ÙŠÙ…ØªØ­Ù†';
                
                html += `
                    <tr class="${rankClass}">
                        <td><strong>#${index + 1}</strong></td>
                        <td>${student.name || 'Ø·Ø§Ù„Ø¨'}</td>
                        <td>${GRADE_NAMES[student.gradeLetter] || student.gradeLetter}</td>
                        <td><strong>${student.calculatedTotalScore || 0}</strong></td>
                        <td>${lastExam}</td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;
        }

        // ========== Search Student ==========
        window.searchStudent = async function() {
            const studentCode = document.getElementById('studentCode').value.trim().toUpperCase();
            
            if (!studentCode) {
                showAlert('âŒ Ù…Ù† ÙØ¶Ù„Ùƒ Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨', 'error');
                return;
            }

            const validPattern = /^[A-E]\d{6}$/;
            if (!validPattern.test(studentCode)) {
                showAlert('âŒ ØµÙŠØºØ© Ø§Ù„ÙƒÙˆØ¯ ØºÙŠØ± ØµØ­ÙŠØ­Ø©', 'error');
                return;
            }

            showLoading();

            try {
                // Get student info
                const studentRef = doc(db, 'students', studentCode);
                const studentSnap = await getDoc(studentRef);

                if (!studentSnap.exists()) {
                    showAlert('âŒ Ø§Ù„Ø·Ø§Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', 'error');
                    hideLoading();
                    return;
                }

                const student = { code: studentCode, ...studentSnap.data() };

                // âœ… Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø·Ø§Ù„Ø¨ (Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠ Ø§Ù„ÙƒØ§Ù…Ù„)
                const resultsRef = collection(db, 'results');
                const q = query(
                    resultsRef, 
                    where('studentCode', '==', studentCode),
                    orderBy('date', 'desc') // Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹ Ù„Ù„ØªØ§ÙŠÙ… Ù„Ø§ÙŠÙ†
                );
                
                const resultsSnap = await getDocs(q);
                const results = resultsSnap.docs.map(doc => doc.data());

                // âœ… Ø­Ø³Ø§Ø¨ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‚Ø§Ø· Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
                const calculatedTotalScore = results.reduce((sum, r) => sum + (r.score || 0), 0);

                renderStudentProgress(student, results, calculatedTotalScore);

            } catch (error) {
                console.error('Error searching student:', error);
                showAlert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«', 'error');
            }

            hideLoading();
        };

        // ========== Render Student Progress ==========
        function renderStudentProgress(student, results, calculatedTotalScore) {
            const container = document.getElementById('studentProgress');
            
            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù…Ù† Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ÙØ¹Ù„ÙŠØ©
            const totalExams = results.length;
            const avgScore = totalExams > 0 
                ? (results.reduce((sum, r) => sum + (r.score || 0), 0) / totalExams).toFixed(1)
                : '0';
            const bestScore = totalExams > 0 
                ? Math.max(...results.map(r => r.score || 0))
                : 0;

            // âœ… ØªØ±ØªÙŠØ¨ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ØªØµØ§Ø¹Ø¯ÙŠØ§Ù‹ Ù„Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ (Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ®)
            const chartResults = [...results].reverse();

            // Ø¨Ù†Ø§Ø¡ Ø§Ù„ØªØ§ÙŠÙ… Ù„Ø§ÙŠÙ† Ù…Ø¹ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„ÙØ¹Ù„ÙŠ Ù„ÙƒÙ„ Ø§Ù…ØªØ­Ø§Ù†
            let resultsHtml = '';
            results.forEach(r => {
                const scoreClass = r.score >= 8 ? 'high' : r.score >= 5 ? 'medium' : 'low';
                const examDate = new Date(r.date).toLocaleDateString('ar-EG', {
                    weekday: 'short',
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
                const examTime = new Date(r.date).toLocaleTimeString('ar-EG', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                // âœ… Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†: Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø© - (Ø£Ø³Ø¨ÙˆØ¹: Ø±Ù‚Ù… Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹)
                const subjectName = SUBJECT_NAMES[r.examSubject] || 'Ø§Ù…ØªØ­Ø§Ù†';
                const weekNumber = r.week || '?';
                
                resultsHtml += `
                    <div class="result-item ${scoreClass}">
                        <div class="result-info">
                            <h4>${subjectName} - <span class="week-badge">Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ${weekNumber}</span></h4>
                            <p>
                                <span>ğŸ“… ${examDate}</span>
                                <span>â±ï¸ ${examTime}</span>
                                <span class="result-badge">${r.totalQuestions || 10} Ø£Ø³Ø¦Ù„Ø©</span>
                            </p>
                        </div>
                        <div class="result-score">${r.score}/10</div>
                    </div>
                `;
            });

            // âœ… Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ Ù…Ø¹ Ø§Ù„Ù…Ø­ÙˆØ± Ø§Ù„Ø£ÙÙ‚ÙŠ (ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†)
            let chartBars = '';
            if (chartResults.length > 0) {
                chartBars = `
                    <div class="chart-bars">
                        ${chartResults.map((r, index) => {
                            const examDate = new Date(r.date).toLocaleDateString('ar-EG', {
                                month: 'short',
                                day: 'numeric'
                            });
                            const barHeight = (r.score || 0) * 20; // 20px Ù„ÙƒÙ„ Ù†Ù‚Ø·Ø© (max 200px)
                            return `
                                <div class="chart-bar-wrapper" title="${SUBJECT_NAMES[r.examSubject]} - Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ${r.week || '?'}">
                                    <div class="chart-bar" style="height: ${barHeight}px;"></div>
                                    <span class="chart-label">${examDate}</span>
                                    <span class="chart-value">${r.score}</span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            }

            container.innerHTML = `
                <div class="student-header">
                    <div>
                        <h3 style="color: #1a2b4c;">${student.name}</h3>
                        <p style="color: #64748b;">${GRADE_NAMES[student.gradeLetter]}</p>
                    </div>
                    <div class="student-badge">${student.code}</div>
                </div>

                <div class="stats-grid-small">
                    <div style="background: white; padding: 15px; border-radius: 16px;">
                        <div style="color: #64748b;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‚Ø§Ø· (Ù…Ø­Ø³ÙˆØ¨)</div>
                        <div style="font-size: 1.8rem; font-weight: 800; color: #1a2b4c;">${calculatedTotalScore}</div>
                    </div>
                    <div style="background: white; padding: 15px; border-radius: 16px;">
                        <div style="color: #64748b;">Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª</div>
                        <div style="font-size: 1.8rem; font-weight: 800; color: #1a2b4c;">${totalExams}</div>
                    </div>
                    <div style="background: white; padding: 15px; border-radius: 16px;">
                        <div style="color: #64748b;">Ø§Ù„Ù…ØªÙˆØ³Ø·</div>
                        <div style="font-size: 1.8rem; font-weight: 800; color: #1a2b4c;">${avgScore}</div>
                    </div>
                    <div style="background: white; padding: 15px; border-radius: 16px;">
                        <div style="color: #64748b;">Ø£ÙØ¶Ù„ Ù†ØªÙŠØ¬Ø©</div>
                        <div style="font-size: 1.8rem; font-weight: 800; color: #1a2b4c;">${bestScore}/10</div>
                    </div>
                </div>

                ${chartResults.length > 0 ? `
                    <div class="chart-container">
                        <h4 style="margin-bottom: 15px;">ğŸ“ˆ ØªÙ‚Ø¯Ù… Ø§Ù„Ø¯Ø±Ø¬Ø§Øª Ø¹Ø¨Ø± Ø§Ù„Ø²Ù…Ù†</h4>
                        ${chartBars}
                    </div>
                ` : ''}

                <h4 style="margin: 20px 0 10px;">ğŸ“‹ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠ Ù„Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª</h4>
                <div class="results-timeline">
                    ${resultsHtml || '<p style="text-align: center; color: #64748b;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ø³Ø§Ø¨Ù‚Ø©</p>'}
                </div>
            `;

            container.style.display = 'block';
        }

        // ========== Refresh Leaderboard ==========
        window.refreshLeaderboard = function() {
            showLoading();
            loadLeaderboard().finally(hideLoading);
            loadQuickStats();
            showAlert('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'success');
        };

        // ========== Auto-refresh date every minute ==========
        setInterval(updateLiveDate, 60000);

        // ========== Cleanup on page unload ==========
        window.addEventListener('beforeunload', () => {
            if (unsubscribeStats) unsubscribeStats();
        });

    </script>
</body>
</html>
